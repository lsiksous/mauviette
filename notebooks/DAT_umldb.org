üíà D√©veloppez un moteur de recommandation de films
#+PROPERTY: header-args:jupyter-python :session *Py* :results raw drawer :cache no :async yes :exports results :eval yes :tangle yes

#+SUBTITLE: Pr√©paration des donn√©es
#+AUTHOR: Laurent Siksous
#+EMAIL: siksous@gmail.com
# #+DATE: 
#+DESCRIPTION: 
#+KEYWORDS: 
#+LANGUAGE:  fr

# specifying the beamer startup gives access to a number of
# keybindings which make configuring individual slides and components
# of slides easier.  See, for instance, C-c C-b on a frame headline.
#+STARTUP: beamer

#+STARTUP: oddeven

# we tell the exporter to use a specific LaTeX document class, as
# defined in org-latex-classes.  By default, this does not include a
# beamer entry so this needs to be defined in your configuration (see
# the tutorial).
#+LaTeX_CLASS: beamer
#+LaTeX_CLASS_OPTIONS: [bigger] 

#+LATEX_HEADER: \usepackage{listings}

#+LATEX_HEADER: \definecolor{UBCblue}{rgb}{0.04706, 0.13725, 0.26667} % UBC Blue (primary)
#+LATEX_HEADER: \usecolortheme[named=UBCblue]{structure}

# Beamer supports alternate themes.  Choose your favourite here
#+BEAMER_COLOR_THEME: dolphin
#+BEAMER_FONT_THEME:  default
#+BEAMER_INNER_THEME: [shadow]rounded
#+BEAMER_OUTER_THEME: infolines

# the beamer exporter expects to be told which level of headlines
# defines the frames.  We use the first level headlines for sections
# and the second (hence H:2) for frames.
#+OPTIONS: ^:nil H:2 toc:nil

# the following allow us to selectively choose headlines to export or not
#+SELECT_TAGS: export
#+EXCLUDE_TAGS: noexport

# for a column view of options and configurations for the individual
# frames
#+COLUMNS: %20ITEM %13BEAMER_env(Env) %6BEAMER_envargs(Args) %4BEAMER_col(Col) %7BEAMER_extra(Extra)

# #+BEAMER_HEADER: \usebackgroundtemplate{\includegraphics[width=\paperwidth,height=\paperheight,opacity=.01]{img/bg2.jpeg}}
# #+BEAMER_HEADER: \logo{\includegraphics[height=.5cm,keepaspectratio]{img/bti_logo2.png}\vspace{240pt}}
# #+BEAMER_HEADER: \setbeamertemplate{background canvas}{\begin{tikzpicture}\node[opacity=.1]{\includegraphics [width=\paperwidth,height=\paperheight]{img/background.jpg}};\end{tikzpicture}}
# #+BEAMER_HEADER: \logo{\includegraphics[width=\paperwidth,height=\paperheight,keepaspectratio]{img/background.jpg}}
#+BEAMER_HEADER: \titlegraphic{\includegraphics[width=50]{img/logo.png}}
# #+BEAMER_HEADER: \definecolor{ft}{RGB}{255, 241, 229}
#+BEAMER_HEADER: \setbeamercolor{background canvas}{bg=ft}

* Preamble
** Emacs Setup                                                    :noexport:

#+begin_src emacs-lisp
(setq org-src-fontify-natively t)

(setq lsp-semantic-tokens-enable t)
(setq lsp-enable-symbol-highlighting t)

(setq lsp-enable-file-watchers nil
      read-process-output-max (* 1024 1024)
      gc-cons-threshold 100000000
      lsp-idle-delay 0.5
      ;;
      lsp-eldoc-hook nil
      lsp-eldoc-enable-hover nil

      ;;pas de fil d'ariane
      lsp-headerline-breadcrumb-enable nil
      ;; pas de imenu voir menu-list
      lsp-enable-imenu nil
      ;; lentille
      lsp-lens-enable t
 
      lsp-semantic-highlighting t
      lsp-modeline-code-actions-enable t
      )
  
(setq lsp-completion-provider :company
      lsp-completion-show-detail t
      lsp-completion-show-kind t)

(setq lsp-ui-doc-enable t
      lsp-ui-doc-show-with-mouse nil
      lsp-ui-doc-show-with-cursor t
      lsp-ui-doc-use-childframe t
      
      lsp-ui-sideline-diagnostic-max-line-length 80

      ;; lsp-ui-imenu
      lsp-ui-imenu-enable nil
      ;; lsp-ui-peek
      lsp-ui-peek-enable t
      ;; lsp-ui-sideline
      lsp-ui-sideline-enable t
      lsp-ui-sideline-ignore-duplicate t
      lsp-ui-sideline-show-symbol t
      lsp-ui-sideline-show-hover t
      lsp-ui-sideline-show-diagnostics t
      lsp-ui-sideline-show-code-actions t
      )

(setq lsp-diagnostics-provider :none
      lsp-modeline-diagnostics-enable nil
      lsp-signature-auto-activate nil ;; you could manually request them via `lsp-signature-activate`
      lsp-signature-render-documentation nil)
#+end_src

#+RESULTS:

** Imports

#+begin_src jupyter-python
%matplotlib inline
%load_ext autoreload
%autoreload 2

import warnings

from pandas.io.parsers.base_parser import _process_date_conversion
from scipy.stats.stats import describe
warnings.filterwarnings("ignore")
import pickle

import numpy as np
import pandas as pd
import matplotlib.pyplot as plt
import seaborn as sns

#from lib import posters

import re
import json

from sklearn.impute import KNNImputer
from sklearn.preprocessing import MinMaxScaler, MultiLabelBinarizer
from sklearn.metrics.pairwise import cosine_similarity
from sklearn.feature_extraction.text import CountVectorizer
#+end_src

#+RESULTS:
:results:
# Out[1]:
:end:

** Functions

#+begin_src jupyter-python
# Display all
def display_all(df):
    with pd.option_context("display.max_rows", 50, "display.max_columns", 25): 
        display(df)
#+end_src

#+RESULTS:
:results:
# Out[2]:
:end:

** Org                                                            :noexport:

#+begin_src jupyter-python
# Org-mode table formatter
import IPython
import tabulate

class OrgFormatter(IPython.core.formatters.BaseFormatter):
    format_type = IPython.core.formatters.Unicode('text/org')
    print_method = IPython.core.formatters.ObjectName('_repr_org_')

def pd_dataframe_to_org(df):
    return tabulate.tabulate(df.head(), headers='keys', tablefmt='orgtbl', showindex='always')

ip = get_ipython()
ip.display_formatter.formatters['text/org'] = OrgFormatter()

f = ip.display_formatter.formatters['text/org']
f.for_type_by_name('pandas.core.frame', 'DataFrame', pd_dataframe_to_org)
#+end_src

#+RESULTS:
:results:
# Out[3]:
:end:

* Data Prep
** Load Data

#+begin_src jupyter-python
df_raw = pd.read_csv('/Users/lss/Sites/simplon.ai/briefs/recsys/data/movie_metadata.csv')
#+end_src

#+RESULTS:
:results:
# Out[4]:
:end:

** Glimpse at the data

#+begin_src jupyter-python
display_all(df_raw.describe(include='all').T)
#+end_src

#+RESULTS:
:results:
# Out[5]:
|                         |   count |   unique | top              |   freq |    mean |       std |   min |   25% |   50% |   75% |   max |
|-------------------------+---------+----------+------------------+--------+---------+-----------+-------+-------+-------+-------+-------|
| color                   |    5024 |        2 | Color            |   4815 | nan     |  nan      |   nan |   nan |   nan | nan   |   nan |
| director_name           |    4939 |     2398 | Steven Spielberg |     26 | nan     |  nan      |   nan |   nan |   nan | nan   |   nan |
| num_critic_for_reviews  |    4993 |      nan | nan              |    nan | 140.194 |  121.602  |     1 |    50 |   110 | 195   |   813 |
| duration                |    5028 |      nan | nan              |    nan | 107.201 |   25.1974 |     7 |    93 |   103 | 118   |   511 |
| director_facebook_likes |    4939 |      nan | nan              |    nan | 686.509 | 2813.33   |     0 |     7 |    49 | 194.5 | 23000 |
:end:


#+begin_src jupyter-python :results output
numerical = df_raw.select_dtypes(include='number').columns
categorical = df_raw.select_dtypes(exclude='number').columns

print(f"categorical columns are : {', '.join(str(x) for x in categorical)}")
print(f"numerical columns are : {', '.join(str(x) for x in numerical)}")
#+end_src

#+RESULTS:
:results:
categorical columns are : color, director_name, actor_2_name, genres, actor_1_name, movie_title, actor_3_name, plot_keywords, movie_imdb_link, language, country, content_rating
numerical columns are : num_critic_for_reviews, duration, director_facebook_likes, actor_3_facebook_likes, actor_1_facebook_likes, gross, num_voted_users, cast_total_facebook_likes, facenumber_in_poster, num_user_for_reviews, budget, title_year, actor_2_facebook_likes, imdb_score, aspect_ratio, movie_facebook_likes
:end:

categorical columns are : color, director_name, actor_2_name, genres,
actor_1_name, movie_title, actor_3_name, plot_keywords, movie_imdb_link,
language, country, content_rating

numerical columns are : num_critic_for_reviews, duration,
director_facebook_likes, actor_3_facebook_likes, actor_1_facebook_likes, gross,
num_voted_users, cast_total_facebook_likes, facenumber_in_poster,
num_user_for_reviews, budget, title_year, actor_2_facebook_likes, imdb_score,
aspect_ratio, movie_facebook_likes

** Distributions of numerical values

#+begin_src jupyter-python
fig, axes = plt.subplots(nrows=4, ncols=4, figsize=(20, 16))
for ax, col in zip(axes.flatten()[:16], numerical):
    sns.distplot(df_raw[col], ax=ax)

plt.show()
#+end_src

#+RESULTS:
:results:
# Out[7]:
[[file:./obipy-resources/gUYjU2.png]]
:end:

** Extract id from url

#+begin_src jupyter-python
df = df_raw.copy()

df['id'] = df.movie_imdb_link.map(lambda x: x.split('/')[4])
df.id.head(10)
#+end_src

#+RESULTS:
:results:
# Out[8]:
#+BEGIN_EXAMPLE
  0    tt0499549
  1    tt0449088
  2    tt2379713
  3    tt1345836
  4    tt5289954
  5    tt0401729
  6    tt0413300
  7    tt0398286
  8    tt2395427
  9    tt0417741
  Name: id, dtype: object
#+END_EXAMPLE
:end:

#+begin_src jupyter-python
df.drop('movie_imdb_link', axis=1, inplace=True)
#+end_src

#+RESULTS:
:results:
# Out[9]:
:end:

#+begin_src jupyter-python
df = df.sort_values(by='id')
#+end_src

#+RESULTS:
:results:
# Out[10]:
:end:

#+begin_src jupyter-python
df = df.set_index('id')
df.head()
#+end_src

#+RESULTS:
:results:
# Out[11]:
| id        | color           | director_name       |   num_critic_for_reviews |   duration |   director_facebook_likes |   actor_3_facebook_likes | actor_2_name    |   actor_1_facebook_likes |     gross | genres              | actor_1_name   | movie_title                                      |   num_voted_users |   cast_total_facebook_likes | actor_3_name       |   facenumber_in_poster | plot_keywords                                                         |   num_user_for_reviews | language   | country   | content_rating   |     budget |   title_year |   actor_2_facebook_likes |   imdb_score |   aspect_ratio |   movie_facebook_likes |
|-----------+-----------------+---------------------+--------------------------+------------+---------------------------+--------------------------+-----------------+--------------------------+-----------+---------------------+----------------+--------------------------------------------------+-------------------+-----------------------------+--------------------+------------------------+-----------------------------------------------------------------------+------------------------+------------+-----------+------------------+------------+--------------+--------------------------+--------------+----------------+------------------------|
| tt0006864 | Black and White | D.W. Griffith       |                       69 |        123 |                       204 |                        9 | Mae Marsh       |                      436 |   nan     | Drama|History|War   | Lillian Gish   | Intolerance: Love's Struggle Throughout the Ages |             10718 |                         481 | Walter Long        |                      1 | huguenot|intolerance|medicis|protestant|wedding                       |                     88 | nan        | USA       | Not Rated        | 385907     |         1916 |                       22 |          8   |           1.33 |                    691 |
| tt0011549 | Black and White | Harry F. Millarde   |                        1 |        110 |                         0 |                        0 | Johnnie Walker  |                        2 |     3e+06 | Crime|Drama         | Stephen Carr   | Over the Hill to the Poorhouse                   |                 5 |                           4 | Mary Carr          |                      1 | family relationships|gang|idler|poorhouse|thief                       |                      1 | nan        | USA       | nan              | 100000     |         1920 |                        2 |          4.8 |           1.33 |                      0 |
| tt0015624 | Black and White | King Vidor          |                       48 |        151 |                        54 |                        6 | Ren√©e Ador√©e    |                       81 |   nan     | Drama|Romance|War   | John Gilbert   | The Big Parade                                   |              4849 |                         108 | Claire Adams       |                      0 | chewing gum|climbing a tree|france|translation problems|world war one |                     45 | nan        | USA       | Not Rated        | 245000     |         1925 |                       12 |          8.3 |           1.33 |                    226 |
| tt0017136 | Black and White | Fritz Lang          |                      260 |        145 |                       756 |                       18 | Gustav Fr√∂hlich |                      136 | 26435     | Drama|Sci-Fi        | Brigitte Helm  | Metropolis                                       |            111841 |                         203 | Rudolf Klein-Rogge |                      1 | art deco|bible quote|dance|silent film|worker                         |                    413 | German     | Germany   | Not Rated        |      6e+06 |         1927 |                       23 |          8.3 |           1.33 |                  12000 |
| tt0018737 | Black and White | Georg Wilhelm Pabst |                       71 |        110 |                        21 |                        3 | Francis Lederer |                      426 |  9950     | Crime|Drama|Romance | Louise Brooks  | Pandora's Box                                    |              7431 |                         455 | Fritz Kortner      |                      1 | escape|femme fatale|german expressionism|lust|violence                |                     84 | German     | Germany   | Not Rated        |    nan     |         1929 |                       20 |          8   |           1.33 |                    926 |
:end:

** Duplicates

#+begin_src jupyter-python
idx = df.index.drop_duplicates(keep=False)
df = df.loc[idx]
#+end_src

#+RESULTS:
:results:
# Out[12]:
:end:

** Getting rid of bad records

- Most records still with nans are not movies but TV shows:

#+begin_src jupyter-python
df[df.color.isna()]
#+end_src

#+RESULTS:
:results:
# Out[13]:
| id        |   color | director_name   |   num_critic_for_reviews |   duration |   director_facebook_likes |   actor_3_facebook_likes | actor_2_name        |   actor_1_facebook_likes |         gross | genres                      | actor_1_name       | movie_title       |   num_voted_users |   cast_total_facebook_likes | actor_3_name   |   facenumber_in_poster | plot_keywords                                                                   |   num_user_for_reviews | language   | country   | content_rating   |    budget |   title_year |   actor_2_facebook_likes |   imdb_score |   aspect_ratio |   movie_facebook_likes |
|-----------+---------+-----------------+--------------------------+------------+---------------------------+--------------------------+---------------------+--------------------------+---------------+-----------------------------+--------------------+-------------------+-------------------+-----------------------------+----------------+------------------------+---------------------------------------------------------------------------------+------------------------+------------+-----------+------------------+-----------+--------------+--------------------------+--------------+----------------+------------------------|
| tt0100146 |     nan | Pece Dingo      |                        1 |         94 |                         0 |                       87 | Wilhelm von Homburg |                      156 | nan           | Horror                      | Michael Des Barres | Midnight Cabaret  |                47 |                         544 | Thom Mathews   |                      0 | cigarette smoking|death|devil|nightmare|satanic cult                            |                      4 | English    | USA       | R                | nan       |         1990 |                      102 |          4.5 |         nan    |                      4 |
| tt0938305 |     nan | Charles Matthau |                       13 |         90 |                       139 |                     1000 | Michael Jai White   |                     2000 | nan           | Comedy|Crime|Thriller       | Billy Burke        | Freaky Deaky      |              6741 |                        6569 | Bill Duke      |                      0 | black panties|bomb squad|car bomb|dynamite|girl in panties                      |                     11 | English    | USA       | R                |   6e+06   |         2012 |                     2000 |          6.5 |         nan    |                      0 |
| tt0989757 |     nan | Lasse Hallstr√∂m |                      162 |        108 |                       529 |                      690 | Henry Thomas        |                    17000 |   8.00148e+07 | Drama|Romance|War           | Channing Tatum     | Dear John         |            104356 |                       19945 | Scott Porter   |                    nan | army|coin collector|love|surfboard|u.s. army                                    |                    186 | English    | USA       | PG-13            |   2.5e+07 |         2010 |                      861 |          6.3 |           2.35 |                  14000 |
| tt1075419 |     nan | Tung-Shing Yee  |                       53 |        119 |                         3 |                       19 | Daniel Wu           |                      556 | nan           | Action|Crime|Drama|Thriller | Bingbing Fan       | Shinjuku Incident |              9177 |                         996 | Yasuaki Kurata |                      4 | chinese|gang|gratitude|immigrant|japan                                          |                     53 | Mandarin   | Hong Kong | R                |   1.5e+07 |         2009 |                      353 |          7.1 |           2.35 |                    821 |
| tt1272886 |     nan | Jonas √Ökerlund  |                       33 |         96 |                        68 |                      722 | Saffron Burrows     |                     2000 | nan           | Comedy|Crime|Drama          | Noel Gugliemi      | Small Apartments  |              5732 |                        3683 | Matt Lucas     |                      6 | fire investigator|landlord|suicide|talking to one's self in a mirror|turpentine |                     26 | English    | USA       | R                |   2e+06   |         2012 |                      811 |          6.1 |           1.85 |                      0 |
:end:

- We get rid of them:

#+begin_src jupyter-python
df.content_rating = df.content_rating.fillna('Not Rated')
df = df[~(df.content_rating.str.contains('TV'))]
#+end_src

#+RESULTS:
:results:
# Out[14]:
:end:

- Records with no language are from the USA:

#+begin_src jupyter-python :exports both
df[df.language.isna()]
#+end_src

#+RESULTS:
:results:
# Out[15]:
| id        | color           | director_name     |   num_critic_for_reviews |   duration |   director_facebook_likes |   actor_3_facebook_likes | actor_2_name   |   actor_1_facebook_likes |         gross | genres                        | actor_1_name   | movie_title                                      |   num_voted_users |   cast_total_facebook_likes | actor_3_name      |   facenumber_in_poster | plot_keywords                                                         |   num_user_for_reviews |   language | country   | content_rating   |       budget |   title_year |   actor_2_facebook_likes |   imdb_score |   aspect_ratio |   movie_facebook_likes |
|-----------+-----------------+-------------------+--------------------------+------------+---------------------------+--------------------------+----------------+--------------------------+---------------+-------------------------------+----------------+--------------------------------------------------+-------------------+-----------------------------+-------------------+------------------------+-----------------------------------------------------------------------+------------------------+------------+-----------+------------------+--------------+--------------+--------------------------+--------------+----------------+------------------------|
| tt0006864 | Black and White | D.W. Griffith     |                       69 |        123 |                       204 |                        9 | Mae Marsh      |                      436 | nan           | Drama|History|War             | Lillian Gish   | Intolerance: Love's Struggle Throughout the Ages |             10718 |                         481 | Walter Long       |                      1 | huguenot|intolerance|medicis|protestant|wedding                       |                     88 |        nan | USA       | Not Rated        | 385907       |         1916 |                       22 |          8   |           1.33 |                    691 |
| tt0011549 | Black and White | Harry F. Millarde |                        1 |        110 |                         0 |                        0 | Johnnie Walker |                        2 |   3e+06       | Crime|Drama                   | Stephen Carr   | Over the Hill to the Poorhouse                   |                 5 |                           4 | Mary Carr         |                      1 | family relationships|gang|idler|poorhouse|thief                       |                      1 |        nan | USA       | Not Rated        | 100000       |         1920 |                        2 |          4.8 |           1.33 |                      0 |
| tt0015624 | Black and White | King Vidor        |                       48 |        151 |                        54 |                        6 | Ren√©e Ador√©e   |                       81 | nan           | Drama|Romance|War             | John Gilbert   | The Big Parade                                   |              4849 |                         108 | Claire Adams      |                      0 | chewing gum|climbing a tree|france|translation problems|world war one |                     45 |        nan | USA       | Not Rated        | 245000       |         1925 |                       12 |          8.3 |           1.33 |                    226 |
| tt0075222 | Color           | Mel Brooks        |                       39 |         87 |                         0 |                      753 | Dom DeLuise    |                      898 | nan           | Comedy|Romance                | Sid Caesar     | Silent Movie                                     |             12666 |                        2951 | Bernadette Peters |                      0 | black comedy|friend|modern silent movie|silent movie|two word title   |                     61 |        nan | USA       | PG               |      4.4e+06 |         1976 |                      842 |          6.7 |           1.85 |                    629 |
| tt0473700 | Color           | Christopher Cain  |                       43 |        111 |                        58 |                      258 | Taylor Handley |                      482 |   1.06656e+06 | Drama|History|Romance|Western | Jon Gries      | September Dawn                                   |              2618 |                        1526 | Trent Ford        |                      0 | massacre|mormon|settler|utah|wagon train                              |                    111 |        nan | USA       | R                |      1.1e+07 |         2007 |                      362 |          5.8 |           1.85 |                    411 |
:end:

- We set them to English:

#+begin_src jupyter-python
df.loc[df.language.isna(), 'language'] = 'English'
#+end_src

#+RESULTS:
:results:
# Out[16]:
:end:


#+begin_src jupyter-python
df[df.title_year.isna()]
#+end_src

#+RESULTS:
:results:
# Out[17]:
| id        | color           |   director_name |   num_critic_for_reviews |   duration |   director_facebook_likes |   actor_3_facebook_likes | actor_2_name    |   actor_1_facebook_likes |   gross | genres                     | actor_1_name     | movie_title                  |   num_voted_users |   cast_total_facebook_likes | actor_3_name   |   facenumber_in_poster | plot_keywords                                                                                              |   num_user_for_reviews | language   | country   | content_rating   |   budget |   title_year |   actor_2_facebook_likes |   imdb_score |   aspect_ratio |   movie_facebook_likes |
|-----------+-----------------+-----------------+--------------------------+------------+---------------------------+--------------------------+-----------------+--------------------------+---------+----------------------------+------------------+------------------------------+-------------------+-----------------------------+----------------+------------------------+------------------------------------------------------------------------------------------------------------+------------------------+------------+-----------+------------------+----------+--------------+--------------------------+--------------+----------------+------------------------|
| tt0042114 | Black and White |             nan |                       15 |         30 |                       nan |                       94 | Art Carney      |                      491 |     nan | Comedy|Family              | Jackie Gleason   | The Honeymooners             |              3446 |                         812 | Joyce Randolph |                      4 | 1950s|bus driver|money scheme|poverty|sewer                                                                |                     31 | English    | USA       | Not Rated        |      nan |          nan |                      154 |          8.7 |           1.33 |                    459 |
| tt0068135 | Color           |             nan |                       13 |        120 |                       nan |                      nan | Michael Douglas |                      416 |     nan | Action|Crime|Drama|Mystery | Karl Malden      | The Streets of San Francisco |              3405 |                         416 | nan            |                      0 | city name in series title|homicide|older man younger man relationship|place in series title|police partner |                     13 | English    | USA       | Not Rated        |      nan |          nan |                        0 |          7.3 |           4    |                    533 |
| tt0094484 | Color           |             nan |                        1 |         60 |                       nan |                      213 | Alan Autry      |                      480 |     nan | Crime|Drama|Mystery        | Carroll O'Connor | In the Heat of the Night     |              2258 |                        1736 | Crystal R. Fox |                      1 | detective|mississippi|police|police detective|small town                                                   |                     24 | English    | USA       | Not Rated        |      nan |          nan |                      360 |          7.4 |           1.33 |                    763 |
| tt0098948 | Color           |             nan |                       19 |         30 |                       nan |                      424 | Tim Daly        |                      685 |     nan | Comedy|Drama               | Steven Weber     | Wings                        |              7646 |                        1884 | Amy Yasbeck    |                      5 | 1990s|brother brother relationship|nantucket island|one word title|sister sister relationship              |                     56 | English    | USA       | Not Rated        |      nan |          nan |                      511 |          7.3 |           1.33 |                   1000 |
| tt0108967 | Color           |             nan |                       14 |        105 |                       nan |                        5 | Bruce Alexander |                      325 |     nan | Crime|Drama|Mystery        | David Jason      | A Touch of Frost             |              4438 |                         344 | John Lyons     |                      1 | cult tv|death|detective inspector|four word title|internal affairs                                         |                     33 | English    | UK        | Not Rated        |      nan |          nan |                        7 |          7.8 |           1.33 |                    361 |
:end:


- Those are again TV Series with no pitches and issued over several years so we
  drop them

#+begin_src jupyter-python
df = df[~(df.title_year.isna())]
df.shape
#+end_src

#+RESULTS:
:results:
# Out[18]:
: (4688, 27)
:end:

** Casting variables

#+begin_src jupyter-python
literal = ['director_name', 'movie_title',
           'actor_2_name', 'actor_3_name',
           'actor_1_name', 'plot_keywords']
categorical = ['color', 'genres',
               'language', 'country', 'content_rating']
numerical = ['num_critic_for_reviews', 'duration', 'gross', 'director_facebook_likes',
             'num_voted_users', 'cast_total_facebook_likes', 'facenumber_in_poster',
             'num_user_for_reviews', 'budget', 'imdb_score',
             'movie_facebook_likes']
#+end_src

#+RESULTS:
:results:
# Out[19]:
:end:

*** genres

#+begin_src jupyter-python
df.genres = df.genres.str.split('|')
df.sample(10)
#+end_src

#+RESULTS:
:results:
# Out[20]:
| id        | color   | director_name   |   num_critic_for_reviews |   duration |   director_facebook_likes |   actor_3_facebook_likes | actor_2_name       |   actor_1_facebook_likes |         gross | genres                                                                           | actor_1_name   | movie_title                   |   num_voted_users |   cast_total_facebook_likes | actor_3_name   |   facenumber_in_poster | plot_keywords                                                                                  |   num_user_for_reviews | language   | country   | content_rating   |    budget |   title_year |   actor_2_facebook_likes |   imdb_score |   aspect_ratio |   movie_facebook_likes |
|-----------+---------+-----------------+--------------------------+------------+---------------------------+--------------------------+--------------------+--------------------------+---------------+----------------------------------------------------------------------------------+----------------+-------------------------------+-------------------+-----------------------------+----------------+------------------------+------------------------------------------------------------------------------------------------+------------------------+------------+-----------+------------------+-----------+--------------+--------------------------+--------------+----------------+------------------------|
| tt0461336 | Color   | Beto G√≥mez      |                       16 |        105 |                         5 |                      122 | Gerardo Taracena   |                      274 |   1.39177e+06 | ['Adventure', 'Comedy', 'Western']                                               | Jaime Camil    | Saving Private Perez          |              1592 |                         793 | Joaqu√≠n Cosio  |                      6 | conflicted hero|flashback|mission|rescue|rescue mission                                        |                     14 | Spanish    | Mexico    | PG-13            | nan       |         2011 |                      154 |          6   |           2.35 |                      0 |
| tt2113659 | Color   | Michael Radford |                       59 |         97 |                        53 |                      499 | Jared Gilman       |                      962 | nan           | ['Comedy', 'Drama', 'Romance']                                                   | Chris Noth     | Elsa & Fred                   |              2041 |                        3465 | James Brolin   |                      0 | apartment|death of protagonist|follow that car|la dolce vita|love                              |                     18 | English    | USA       | PG-13            |   1e+07   |         2014 |                      545 |          6.5 |           2.35 |                      0 |
| tt0120794 | Color   | Brenda Chapman  |                      120 |         99 |                        59 |                      145 | Aria Noelle Curzon |                      770 |   1.01218e+08 | ['Adventure', 'Animation', 'Biography', 'Drama', 'Family', 'Fantasy', 'Musical'] | Martin Short   | The Prince of Egypt           |             91093 |                        1195 | Eden Riegel    |                      2 | ancient egypt|hebrew|nudity|pharaoh|title directed by female                                   |                    353 | English    | USA       | PG               |   7e+07   |         1998 |                      263 |          7   |           1.85 |                      0 |
| tt1870529 | Color   | Daniel Barnz    |                      102 |        121 |                        33 |                      505 | Rosie Perez        |                     1000 |   5.30855e+06 | ['Drama']                                                                        | Holly Hunter   | Won't Back Down               |              5147 |                        3260 | Dante Brown    |                      2 | children|inner city|parent|school|teacher                                                      |                     37 | English    | USA       | PG               | nan       |         2012 |                      919 |          6.4 |           2.35 |                      0 |
| tt0092076 | Color   | Tobe Hooper     |                      159 |        101 |                       365 |                       14 | Lou Perryman       |                      237 |   8.02587e+06 | ['Comedy', 'Horror']                                                             | Bill Johnson   | The Texas Chainsaw Massacre 2 |             19234 |                         302 | Jim Siedow     |                      3 | chainsaw|chainsaw murder|human monster|music score composed by director|obscene finger gesture |                    258 | English    | USA       | X                |   4.7e+06 |         1986 |                       28 |          5.5 |           1.85 |                      0 |
:end:


#+begin_src jupyter-python
mlb = MultiLabelBinarizer()
df_genres = pd.DataFrame(mlb.fit_transform(df.genres), columns=mlb.classes_, index=df.index)
df_genres.sample(20)
#+end_src

#+RESULTS:
:results:
# Out[21]:
| id        |   Action |   Adventure |   Animation |   Biography |   Comedy |   Crime |   Documentary |   Drama |   Family |   Fantasy |   Film-Noir |   History |   Horror |   Music |   Musical |   Mystery |   News |   Romance |   Sci-Fi |   Short |   Sport |   Thriller |   War |   Western |
|-----------+----------+-------------+-------------+-------------+----------+---------+---------------+---------+----------+-----------+-------------+-----------+----------+---------+-----------+-----------+--------+-----------+----------+---------+---------+------------+-------+-----------|
| tt1588337 |        0 |           0 |           0 |           0 |        0 |       0 |             0 |       1 |        0 |         0 |           0 |         0 |        0 |       0 |         0 |         0 |      0 |         0 |        0 |       0 |       0 |          0 |     0 |         0 |
| tt1135487 |        0 |           0 |           0 |           0 |        1 |       1 |             0 |       0 |        0 |         0 |           0 |         0 |        0 |       0 |         0 |         0 |      0 |         1 |        0 |       0 |       0 |          1 |     0 |         0 |
| tt0395119 |        0 |           1 |           0 |           0 |        0 |       0 |             0 |       1 |        0 |         0 |           0 |         1 |        0 |       0 |         0 |         0 |      0 |         1 |        0 |       0 |       0 |          1 |     1 |         0 |
| tt0378194 |        1 |           0 |           0 |           0 |        0 |       1 |             0 |       1 |        0 |         0 |           0 |         0 |        0 |       0 |         0 |         0 |      0 |         0 |        0 |       0 |       0 |          1 |     0 |         0 |
| tt2709768 |        0 |           0 |           1 |           0 |        1 |       0 |             0 |       0 |        1 |         0 |           0 |         0 |        0 |       0 |         0 |         0 |      0 |         0 |        0 |       0 |       0 |          0 |     0 |         0 |
:end:

#+begin_src jupyter-python
df.drop('genres', axis=1, inplace=True)
#+end_src

#+RESULTS:
:results:
# Out[22]:
:end:


*** plots

#+begin_src jupyter-python
df.plot_keywords.head()
#+end_src

#+RESULTS:
:results:
# Out[23]:
#+BEGIN_EXAMPLE
  id
  tt0006864      huguenot|intolerance|medicis|protestant|wedding
  tt0011549      family relationships|gang|idler|poorhouse|thief
  tt0015624    chewing gum|climbing a tree|france|translation...
  tt0017136        art deco|bible quote|dance|silent film|worker
  tt0018737    escape|femme fatale|german expressionism|lust|...
  Name: plot_keywords, dtype: object
#+END_EXAMPLE
:end:

#+begin_src jupyter-python
df.plot_keywords = df.plot_keywords.str.replace('|', ", ")
#+end_src

#+RESULTS:
:results:
# Out[24]:
:end:

#+begin_src jupyter-python :exports both
df.sample(10)
#+end_src

#+RESULTS:
:results:
# Out[25]:
| id        | color           | director_name     |   num_critic_for_reviews |   duration |   director_facebook_likes |   actor_3_facebook_likes | actor_2_name      |   actor_1_facebook_likes |       gross | actor_1_name       | movie_title            |   num_voted_users |   cast_total_facebook_likes | actor_3_name          |   facenumber_in_poster | plot_keywords                                                                       |   num_user_for_reviews | language   | country   | content_rating   |      budget |   title_year |   actor_2_facebook_likes |   imdb_score |   aspect_ratio |   movie_facebook_likes |
|-----------+-----------------+-------------------+--------------------------+------------+---------------------------+--------------------------+-------------------+--------------------------+-------------+--------------------+------------------------+-------------------+-----------------------------+-----------------------+------------------------+-------------------------------------------------------------------------------------+------------------------+------------+-----------+------------------+-------------+--------------+--------------------------+--------------+----------------+------------------------|
| tt1650554 | Color           | Jeff Wadlow       |                      350 |        103 |                        65 |                      405 | Donald Faison     |                    17000 | 2.87517e+07 | Chlo√´ Grace Moretz | Kick-Ass 2             |            202967 |                       19168 | Augustus Prew         |                      0 | hit in the crotch, kicked in the crotch, punched in the crotch, sparring, superhero |                    378 | English    | USA       | R                |     2.8e+07 |         2013 |                      927 |          6.6 |           2.35 |                  36000 |
| tt1951181 | Color           | James Gray        |                      230 |        120 |                       115 |                      310 | Dagmara Dominczyk |                    10000 | 1.98474e+06 | Jeremy Renner      | The Immigrant          |             20616 |                       11019 | Angela Sarafyan       |                      3 | immigrant, immigration, magician, money, prostitution                               |                     70 | English    | USA       | R                |     1.6e+07 |         2013 |                      316 |          6.6 |           2.35 |                      0 |
| tt1188996 | Color           | Karan Johar       |                      210 |        128 |                       160 |                       81 | Jimmy Shergill    |                     8000 | 4.0187e+06  | Shah Rukh Khan     | My Name Is Khan        |             69759 |                        8532 | Christopher B. Duncan |                      2 | airport, asperger's syndrome, autism, muslim, racial profiling                      |                    235 | Hindi      | India     | PG-13            |     1.2e+07 |         2010 |                      327 |          8   |           2.35 |                  27000 |
| tt0102943 | Black and White | Richard Linklater |                       61 |        100 |                         0 |                        0 | Richard Linklater |                        5 | 1.22751e+06 | Tommy Pallotta     | Slacker                |             15103 |                           5 | Jean Caffeine         |                      0 | austin texas, moon, pap smear, texas, twenty something                              |                     80 | English    | USA       | R                | 23000       |         1991 |                        0 |          7.1 |           1.37 |                   2000 |
| tt0405422 | Color           | Judd Apatow       |                      217 |        133 |                         0 |                      218 | Romany Malco      |                     7000 | 1.09243e+08 | Steve Carell       | The 40-Year-Old Virgin |            313797 |                        8341 | Gerry Bednob          |                      1 | 40 year old, car accident, cheating on girlfriend, collection, porno movie          |                    546 | English    | USA       | R                |     2.6e+07 |         2005 |                      966 |          7.1 |           1.85 |                      0 |
:end:

** KNN Imputation of numerical variables

#+begin_src jupyter-python :exports both
imputer = KNNImputer(n_neighbors=5)
df_num = pd.DataFrame(imputer.fit_transform(df[numerical]),columns = df[numerical].columns)
df_num.sample(20)
#+end_src

#+RESULTS:
:results:
# Out[26]:
|      |   num_critic_for_reviews |   duration |       gross |   director_facebook_likes |   num_voted_users |   cast_total_facebook_likes |   facenumber_in_poster |   num_user_for_reviews |       budget |   imdb_score |   movie_facebook_likes |
|------+--------------------------+------------+-------------+---------------------------+-------------------+-----------------------------+------------------------+------------------------+--------------+--------------+------------------------|
| 4331 |                       90 |         91 | 1.0214e+07  |                        31 |             23072 |                        1564 |                      2 |                     89 |     3.5e+07  |          5.4 |                      0 |
| 2630 |                      151 |        103 | 7.94816e+06 |                       189 |             48999 |                        6563 |                      1 |                    280 |     3.5e+07  |          6   |                      0 |
|  194 |                      152 |         89 | 9.65872e+06 |                         0 |             69831 |                         837 |                      1 |                    535 | 20000        |          7.4 |                      0 |
| 4424 |                      322 |        122 | 1.30469e+08 |                       681 |             53607 |                        1327 |                      4 |                    432 |     1.85e+08 |          7.5 |                  30000 |
|  543 |                       30 |         98 | 7.43473e+06 |                        23 |             14473 |                        3671 |                      2 |                     81 |     2.3e+07  |          6   |                      0 |
:end:

#+begin_src jupyter-python :exports both
df.drop(numerical, axis=1, inplace=True)
df.head()
#+end_src

#+RESULTS:
:results:
# Out[27]:
| id        | color           | director_name       |   actor_3_facebook_likes | actor_2_name    |   actor_1_facebook_likes | actor_1_name   | movie_title                                      | actor_3_name       | plot_keywords                                                             | language   | country   | content_rating   |   title_year |   actor_2_facebook_likes |   aspect_ratio |
|-----------+-----------------+---------------------+--------------------------+-----------------+--------------------------+----------------+--------------------------------------------------+--------------------+---------------------------------------------------------------------------+------------+-----------+------------------+--------------+--------------------------+----------------|
| tt0006864 | Black and White | D.W. Griffith       |                        9 | Mae Marsh       |                      436 | Lillian Gish   | Intolerance: Love's Struggle Throughout the Ages | Walter Long        | huguenot, intolerance, medicis, protestant, wedding                       | English    | USA       | Not Rated        |         1916 |                       22 |           1.33 |
| tt0011549 | Black and White | Harry F. Millarde   |                        0 | Johnnie Walker  |                        2 | Stephen Carr   | Over the Hill to the Poorhouse                   | Mary Carr          | family relationships, gang, idler, poorhouse, thief                       | English    | USA       | Not Rated        |         1920 |                        2 |           1.33 |
| tt0015624 | Black and White | King Vidor          |                        6 | Ren√©e Ador√©e    |                       81 | John Gilbert   | The Big Parade                                   | Claire Adams       | chewing gum, climbing a tree, france, translation problems, world war one | English    | USA       | Not Rated        |         1925 |                       12 |           1.33 |
| tt0017136 | Black and White | Fritz Lang          |                       18 | Gustav Fr√∂hlich |                      136 | Brigitte Helm  | Metropolis                                       | Rudolf Klein-Rogge | art deco, bible quote, dance, silent film, worker                         | German     | Germany   | Not Rated        |         1927 |                       23 |           1.33 |
| tt0018737 | Black and White | Georg Wilhelm Pabst |                        3 | Francis Lederer |                      426 | Louise Brooks  | Pandora's Box                                    | Fritz Kortner      | escape, femme fatale, german expressionism, lust, violence                | German     | Germany   | Not Rated        |         1929 |                       20 |           1.33 |
:end:


** Getting it all back together

- Let's check everything is in good shape

#+begin_src jupyter-python :exports both
df_num.shape, df_genres.shape
#+end_src

#+RESULTS:
:results:
# Out[28]:
: ((4688, 11), (4688, 24))
:end:

- Concatenate genras

#+begin_src jupyter-python :exports both
df = pd.concat([df, df_genres], axis = 1)
#+end_src

#+RESULTS:
:results:
# Out[29]:
:end:


- Concatenate numericals

#+begin_src jupyter-python :exports both
df = df.reset_index()
df = pd.concat([df, df_num], axis = 1)
#+end_src

#+RESULTS:
:results:
# Out[30]:
:end:

#+begin_src jupyter-python
df
#+end_src

#+RESULTS:
:results:
# Out[59]:
|   | id        | color           | director_name       | actor_3_facebook_likes | actor_2_name    | actor_1_facebook_likes | actor_1_name  | movie_title                                      | actor_3_name       | plot_keywords                                                             | language | country | content_rating | title_year | actor_2_facebook_likes | aspect_ratio | Action | Adventure | Animation | Biography | Comedy | Crime | Documentary | Drama | Family | Fantasy | Film-Noir | History | Horror | Music | Musical | Mystery | News | Romance | Sci-Fi | Short | Sport | Thriller | War | Western | num_critic_for_reviews | duration |       gross | director_facebook_likes | num_voted_users | cast_total_facebook_likes | facenumber_in_poster | num_user_for_reviews |   budget | imdb_score | movie_facebook_likes |
|---+-----------+-----------------+---------------------+------------------------+-----------------+------------------------+---------------+--------------------------------------------------+--------------------+---------------------------------------------------------------------------+----------+---------+----------------+------------+------------------------+--------------+--------+-----------+-----------+-----------+--------+-------+-------------+-------+--------+---------+-----------+---------+--------+-------+---------+---------+------+---------+--------+-------+-------+----------+-----+---------+------------------------+----------+-------------+-------------------------+-----------------+---------------------------+----------------------+----------------------+----------+------------+----------------------|
| 0 | tt0006864 | Black and White | D.W. Griffith       |                      9 | Mae Marsh       |                    436 | Lillian Gish  | Intolerance: Love's Struggle Throughout the Ages | Walter Long        | huguenot, intolerance, medicis, protestant, wedding                       | English  | USA     | Not Rated      |       1916 |                     22 |         1.33 |      0 |         0 |         0 |         0 |      0 |     0 |           0 |     1 |      0 |       0 |         0 |       1 |      0 |     0 |       0 |       0 |    0 |       0 |      0 |     0 |     0 |        0 |   1 |       0 |                     69 |      123 | 1.17391e+06 |                     204 |           10718 |                       481 |                    1 |                   88 |   385907 |          8 |                  691 |
| 1 | tt0011549 | Black and White | Harry F. Millarde   |                      0 | Johnnie Walker  |                      2 | Stephen Carr  | Over the Hill to the Poorhouse                   | Mary Carr          | family relationships, gang, idler, poorhouse, thief                       | English  | USA     | Not Rated      |       1920 |                      2 |         1.33 |      0 |         0 |         0 |         0 |      0 |     1 |           0 |     1 |      0 |       0 |         0 |       0 |      0 |     0 |       0 |       0 |    0 |       0 |      0 |     0 |     0 |        0 |   0 |       0 |                      1 |      110 |       3e+06 |                       0 |               5 |                         4 |                    1 |                    1 |   100000 |        4.8 |                    0 |
| 2 | tt0015624 | Black and White | King Vidor          |                      6 | Ren√©e Ador√©e    |                     81 | John Gilbert  | The Big Parade                                   | Claire Adams       | chewing gum, climbing a tree, france, translation problems, world war one | English  | USA     | Not Rated      |       1925 |                     12 |         1.33 |      0 |         0 |         0 |         0 |      0 |     0 |           0 |     1 |      0 |       0 |         0 |       0 |      0 |     0 |       0 |       0 |    0 |       1 |      0 |     0 |     0 |        0 |   1 |       0 |                     48 |      151 | 2.19638e+06 |                      54 |            4849 |                       108 |                    0 |                   45 |   245000 |        8.3 |                  226 |
| 3 | tt0017136 | Black and White | Fritz Lang          |                     18 | Gustav Fr√∂hlich |                    136 | Brigitte Helm | Metropolis                                       | Rudolf Klein-Rogge | art deco, bible quote, dance, silent film, worker                         | German   | Germany | Not Rated      |       1927 |                     23 |         1.33 |      0 |         0 |         0 |         0 |      0 |     0 |           0 |     1 |      0 |       0 |         0 |       0 |      0 |     0 |       0 |       0 |    0 |       0 |      1 |     0 |     0 |        0 |   0 |       0 |                    260 |      145 |       26435 |                     756 |          111841 |                       203 |                    1 |                  413 |    6e+06 |        8.3 |                12000 |
| 4 | tt0018737 | Black and White | Georg Wilhelm Pabst |                      3 | Francis Lederer |                    426 | Louise Brooks | Pandora's Box                                    | Fritz Kortner      | escape, femme fatale, german expressionism, lust, violence                | German   | Germany | Not Rated      |       1929 |                     20 |         1.33 |      0 |         0 |         0 |         0 |      0 |     1 |           0 |     1 |      0 |       0 |         0 |       0 |      0 |     0 |       0 |       0 |    0 |       1 |      0 |     0 |     0 |        0 |   0 |       0 |                     71 |      110 |        9950 |                      21 |            7431 |                       455 |                    1 |                   84 | 2.86e+06 |          8 |                  926 |
:end:

#+begin_src jupyter-python
#display_all(df.describe(include='all').T)

dg = df.iloc[:,16:40]
for genre in dg.columns:
    print(dg.groupby(genre).groups)
#+end_src

#+RESULTS:
:results:
# Out[53]:
:end:

** Save data

#+begin_src jupyter-python
df.to_csv('./data/movie_metadata_clean.csv')
#+end_src

#+RESULTS:
:results:
# Out[32]:
:end:

* Bibliography
** References
:PROPERTIES:
:BEAMER_opt: shrink=10
:END:

bibliographystyle:unsrt
bibliography:umldb.bib

* Local Variables                                                  :noexport:
# Local Variables:
# eval: (setenv "PATH" "/Library/TeX/texbin/:$PATH" t)
# End:
